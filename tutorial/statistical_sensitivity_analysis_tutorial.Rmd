---
title: "Statistical Sensitivity Analysis Tutorial"
author: "Brice Ozenne"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Introduction

This tutorial demonstrates a sensitivity analysis framework for multiverse analyses, following the approach described in the manuscript "A sensitivity analysis of preprocessing pipelines: Toward a solution for multiverse analyses". The framework uses statistical tools for assessing the heterogeneity of multiple preprocessing pipelines and testing hypotheses across them.

# Setup

Load the necessary R packages:

```{library(mvtnorm)}
library(Matrix)
library(LMMstar)
```

# Data Simulation

We will first simulate data for a multiverse scenario. Below is an example of simulating three different noise structures (homoscedastic, heteroscedastic, and correlated heteroscedastic noise):

```{# Example of simulating correlated heteroscedastic noise}
set.seed(123)

# Number of subjects
n <- 100 

# Number of pipelines
J <- 20 

# Simulate noise for scenario 3
sigma_scenario3 <- diag(rep(1, J)) 
sigma_scenario3[1:15, 1:15] <- 0.95
diag(sigma_scenario3) <- 1

# Generate data
data_scenario3 <- rmvnorm(n, mean = rep(0, J), sigma = sigma_scenario3)
```

# Visualizing Data

To better understand the correlation structure across pipelines, we use a heatmap:

```{library(ggplot2)}
library(reshape2)

# Correlation matrix
cor_matrix <- cor(data_scenario3)

# Visualize as a heatmap
heatmap(cor_matrix, main = "Correlation Matrix - Scenario 3", symm = TRUE)
```

# Statistical Analysis

We use the LMMstar package for statistical sensitivity analysis. The following code calculates the GLS estimator for the global effect across pipelines:

```{# Compute GLS weights}
gls_weights <- solve(t(rep(1, J)) %*% solve(sigma_scenario3) %*% rep(1, J))
gls_weights
```

# Results and Interpretation

The results of the GLS estimator provide insight into the global effects across pipelines.

```{# Combine GLS results}
combined_results <- data.frame(
  Pipeline = 1:J,
  Weight = gls_weights
)

print(combined_results)
```

# Conclusion

This tutorial provides an overview of using R for sensitivity analysis of multiverse pipelines. For further details, refer to the original paper and the corresponding R code.
